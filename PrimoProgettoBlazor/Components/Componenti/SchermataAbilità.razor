@inject DialogService dialog
@inject IAbilitàService abilitàService
<RadzenPanel Text="@Titolo" AllowCollapse="@Collapsable" class="w-100">
	<RadzenRow class="rz-pb-2">
		<AbilitàSelector Positivo="@IsAbilità" AbilitàTotali="AbilitàTotali" OnInserisciAbilità="InserisciAbilità" />
	</RadzenRow>
	@foreach (AbilitàPersonaggio singola in Abilità.Where(x => x.Abilità.IsAbilità == IsAbilità))
	{
		<RadzenRow class="rz-pb-2">
			<RadzenColumn Size="4">
				<RadzenText class="w-100">@singola.Abilità.Nome</RadzenText>
			</RadzenColumn>
			<RadzenColumn Size="2">
				@if (!singola.Modifica)
				{
					<RadzenText class="w-100">@singola.Punteggio</RadzenText>
				}
				else
				{
					<RadzenNumeric class="w-100" @bind-Value="@singola.Punteggio" />
				}
			</RadzenColumn>
			<RadzenColumn Size="2">
				@if (!singola.Modifica)
				{
					<RadzenButton Icon="edit" ButtonStyle="ButtonStyle.Warning" class="w-100" Click="x => singola.Modifica = true" />
				}
				else
				{
					<RadzenButton Icon="edit" ButtonStyle="ButtonStyle.Primary" class="w-100" Click="x => singola.Modifica = false" />
				}
			</RadzenColumn>
			<RadzenColumn Size="2">
				<RadzenButton Icon="menu" ButtonStyle="ButtonStyle.Primary" Click="x => VisualizzaDescrizione(singola.Abilità)" class="w-100" />
			</RadzenColumn>
			<RadzenColumn Size="2">
				<RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Click="x => EliminaAbilità(singola)" class="w-100" />
			</RadzenColumn>
		</RadzenRow>
	}
</RadzenPanel>

@code {
	[Parameter] public string Titolo { get; set; }
	[Parameter] public ICollection<AbilitàPersonaggio> Abilità { get; set; }
	[Parameter] public EventCallback<ICollection<AbilitàPersonaggio>> AbilitàChanged { get; set; }
	[Parameter] public bool IsAbilità { get; set; } = true; 
	[Parameter] public bool Collapsable { get; set; } = true; 
	[Parameter] public EventCallback<AbilitàPersonaggio> EliminaAbilitàPersonaggio { get; set; }
	[Parameter] public EventCallback<AbilitàPersonaggio> OnInserisciAbilità { get; set; }
	
	List<Abilità> AbilitàTotali = new List<Abilità>();

	protected override async Task OnInitializedAsync()
	{
		AbilitàTotali = await abilitàService.GetAbilità();
	}

	private async Task ChangePunteggio(AbilitàPersonaggio abilitàPersonaggio, int punteggioNuovo)
	{
		abilitàPersonaggio.Punteggio = punteggioNuovo; 
		await AbilitàChanged.InvokeAsync(Abilità); 
	}

	private async Task VisualizzaDescrizione(Abilità abilità)
	{
		await dialog.OpenAsync<SchedaAbilità>(abilità.Nome, new Dictionary<string, object>()
		{
			{"Abilità", abilità}
		}, new DialogOptions()
		{
			Width = "100vw",
			Height = "100vh", 
			ShowClose = true
		});
	}

	private async Task EliminaAbilità(AbilitàPersonaggio quale)
	{
		if (EliminaAbilitàPersonaggio.HasDelegate)
		{
			await EliminaAbilitàPersonaggio.InvokeAsync(quale); 
		}
	}

	private void InserisciAbilità(AbilitàPersonaggio abilitàPersonaggio)
	{
		if (OnInserisciAbilità.HasDelegate)
		{
			OnInserisciAbilità.InvokeAsync(abilitàPersonaggio); 
		}
	}
}
