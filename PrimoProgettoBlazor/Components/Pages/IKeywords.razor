@page "/Keywords"
@inject ICategoriaKeywordService categoriaKeywordService
@inject IKeywordService keywordService
@inject DialogService dialog
@inject NotificationService notify

@if (keyword == null)
{
	<RadzenRow class="mb-2">
		<RadzenColumn Size="12">
			<RadzenDropDown Data="CategorieKeywords" Placeholder="Scegli una categoria" @bind-Value="scelta" TextProperty="@(nameof(CategoriaKeyword.Nome))" class="w-100"/>
		</RadzenColumn>
	</RadzenRow>
	
	if(scelta.Id != 0)
	{
		<RadzenRow>
			@foreach (Keyword singola in scelta.Keywords)
			{
				<RadzenColumn SizeMD="6" Size="12">
					<RadzenCard>
						<RadzenRow>
							<RadzenColumn Size="12">
								<RadzenText TextAlign="TextAlign.Center" Text="@singola.Titolo" />
							</RadzenColumn>
						</RadzenRow>
						<RadzenRow>
							<RadzenColumn Size="6">
								<RadzenButton ButtonStyle="ButtonStyle.Danger" Icon="delete" Click="x => Elimina(singola)" class="w-100" />
							</RadzenColumn>
							<RadzenColumn Size="6">
								<RadzenButton ButtonStyle="ButtonStyle.Warning" Icon="edit" Click="x => Modifica(singola)" class="w-100" />
							</RadzenColumn>
						</RadzenRow>
					</RadzenCard>
				</RadzenColumn>
			}
		</RadzenRow>
	}
	<RadzenFab Style="position:fixed;bottom:1rem;right:1rem;" ButtonType="ButtonType.Button" ButtonStyle="ButtonStyle.Primary" Icon="add" Click="x => Modifica(new Keyword())" />
}
else
{
	<EditForm Model="keyword" OnSubmit="Salva">
		<RadzenRow>
			<RadzenColumn Size="12" SizeMD="6">
				<RadzenFormField Text="Nome" class="w-100">
					<RadzenTextBox @bind-Value="@keyword.Titolo" class="w-100" />
				</RadzenFormField>
			</RadzenColumn>
			<RadzenColumn Size="12" SizeMD="3">
				<RadzenFormField Text="Categoria" class="w-100">
					<RadzenDropDown Data="CategorieKeywords" @bind-Value="@keyword.CategoriaKeyword" TextProperty="@(nameof(CategoriaKeyword.Nome))" class="w-100" />
				</RadzenFormField>
			</RadzenColumn>
			<RadzenColumn Size="12" SizeMD="3" Visible="@giocatore.IsAdmin">
				<RadzenText Text="Visibile solo dall'amministratore" />
				<RadzenSwitch @bind-Value="@keyword.VisibileSoloDaAdmin" />
			</RadzenColumn>
			<RadzenColumn Size="12">
				<RadzenFormField Text="Nome" class="w-100">
					<RadzenTextArea @bind-Value="@keyword.Descrizione" class="w-100" />
				</RadzenFormField>
			</RadzenColumn>
		</RadzenRow>
		<RadzenFab Style="position:fixed;bottom:1rem;right:1rem;" ButtonType="ButtonType.Submit" ButtonStyle="ButtonStyle.Primary" Icon="save" />
	</EditForm>
}

@code {
	[CascadingParameter] public Giocatore giocatore { get; set; }

	List<CategoriaKeyword> CategorieKeywords = new List<CategoriaKeyword>();
	CategoriaKeyword scelta = new CategoriaKeyword();
	Keyword? keyword = null;
	protected override async Task OnInitializedAsync()
	{
		await Carica();
	}

	private async Task Carica()
	{
		CategorieKeywords = await categoriaKeywordService.GetCategorieKeyword(giocatore, true);
	}

	private void Modifica(Keyword quale)
	{
		if (quale.Id == 0 && scelta.Id != 0)
		{
			quale.CategoriaKeyword = scelta; 
			quale.CategoriaKeywordId = scelta.Id; 
		}
		keyword = quale;
	}

	private async Task Salva()
	{
		string errore = await keywordService.SalvaKeyword(keyword);
		MostraErrore(errore, "Inserimento riuscito");
		keyword = null;
		await Carica();
	}

	private async Task Elimina(Keyword quale)
	{
		bool? result = await dialog.Confirm("Sei sicuro di voler eliminare questa categoria?", "Eliminazione categoria", new ConfirmOptions() { OkButtonText = "Sì", CancelButtonText = "No" });
		if (result.HasValue && result.Value)
		{
			string errore = await keywordService.EliminaKeyword(quale);
			MostraErrore(errore, "Elinimazione riuscita!");
			await Carica();
		}
	}

	private void MostraErrore(string errore, string messaggioDiRiuscita)
	{
		if (string.IsNullOrEmpty(errore))
		{
			notify.Notify(NotificationSeverity.Success, messaggioDiRiuscita);
		}
		else
		{
			notify.Notify(NotificationSeverity.Error, errore);
		}
	}
}
