@page "/scheda"
@page "/scheda/{IdPersonaggio:int}"
@inject IPersonaggioService personaggioService
@inject IAbilitàPersonaggioService abilitàPersonaggioService
@inject IAbilitàService abilitàService
@inject DialogService dialog
@inject NotificationService notify
@inject NavigationManager navman

<EditForm Model="@personaggio" OnSubmit="Salva">
	<RadzenRow>
		<RadzenColumn Size="12">
			<RadzenFormField Text="Nome" Variant="Variant.Outlined" class="w-100">
				<RadzenTextBox @bind-Value="@personaggio.Nome" class="w-100" />
			</RadzenFormField>
		</RadzenColumn>
	</RadzenRow>
	<RadzenFieldset Text="Modificatori" AllowCollapse="false" class="w-100">
		<RadzenRow>
			<RadzenColumn Size="6" SizeMD="3">
				<RadzenFormField Text="Iniziativa" Variant="Variant.Outlined" class="w-100">
					<RadzenTextBox @bind-Value="@personaggio.Iniziativa" class="w-100" />
				</RadzenFormField>
			</RadzenColumn>
			<RadzenColumn Size="6" SizeMD="3">
				<RadzenFormField Text="Tiro per colpire" Variant="Variant.Outlined" class="w-100">
					<RadzenTextBox @bind-Value="@personaggio.TiroColpire" class="w-100" />
				</RadzenFormField>
			</RadzenColumn>
			<RadzenColumn Size="6" SizeMD="3">
				<RadzenFormField Text="Tiro difesa" Variant="Variant.Outlined" class="w-100">
					<RadzenTextBox @bind-Value="@personaggio.TiroDifesa" class="w-100" />
				</RadzenFormField>
			</RadzenColumn>
			<RadzenColumn Size="6" SizeMD="3">
				<RadzenFormField Text="Modificatore attacco" Variant="Variant.Outlined" class="w-100">
					<RadzenTextBox @bind-Value="@personaggio.ModifAttacco" class="w-100" />
				</RadzenFormField>
			</RadzenColumn>
		</RadzenRow>
	</RadzenFieldset>
	<RadzenFieldset Text="Statistiche" AllowCollapse="false" class="w-100">
		<RadzenRow>
			<RadzenColumn Size="6" SizeMD="3">
				<RadzenFormField Text="Salute" Variant="Variant.Outlined" class="w-100">
					<RadzenNumeric @bind-Value="@personaggio.Salute" class="w-100" />
				</RadzenFormField>
			</RadzenColumn>
			<RadzenColumn Size="6" SizeMD="3">
				<RadzenFormField Text="Vigore" Variant="Variant.Outlined" class="w-100">
					<RadzenNumeric @bind-Value="@personaggio.Vigore" class="w-100" />
				</RadzenFormField>
			</RadzenColumn>
			<RadzenColumn Size="6" SizeMD="3">
				<RadzenFormField Text="Armatura" Variant="Variant.Outlined" class="w-100">
					<RadzenNumeric @bind-Value="@personaggio.Armatura" class="w-100" />
				</RadzenFormField>
			</RadzenColumn>
			<RadzenColumn Size="6" SizeMD="3">
				<RadzenFormField Text="Livello minaccia" Variant="Variant.Outlined" class="w-100">
					<RadzenNumeric @bind-Value="@personaggio.LivelloMinaccia" class="w-100" />
				</RadzenFormField>
			</RadzenColumn>
		</RadzenRow>
	</RadzenFieldset>
	<RadzenFieldset Text="Abilità e Debolezze" AllowCollapse="false" class="w-100">
		<RadzenRow>
			<RadzenColumn Size="12" SizeMD="8">
				<RadzenFormField Text="Nome Abilità" Variant="Variant.Outlined" class="w-100">
					<RadzenDropDown Data="@AbilitàTotali"
					@bind-Value="@abilitàPersonaggio.Abilità"
					TextProperty="@(nameof(Abilità.Nome))"
					class="w-100" />
				</RadzenFormField>
			</RadzenColumn>
			<RadzenColumn Size="12" SizeMD="2">
				<RadzenFormField Text="Punteggio" Variant="Variant.Outlined" class="w-100">
					<RadzenNumeric @bind-Value="@abilitàPersonaggio.Punteggio" class="w-100" />
				</RadzenFormField>
			</RadzenColumn>
			<RadzenColumn Size="12" SizeMD="2">
				<RadzenButton Icon="add" ButtonStyle="ButtonStyle.Primary" Click="x => InserisciAbilità()" class="w-100 h-100" />
			</RadzenColumn>
		</RadzenRow>
		<RadzenRow>
			<RadzenColumn Size="12" SizeMD="6">
				<SchermataAbilità Titolo="Abilità" @bind-Abilità="personaggio.Abilità" IsAbilità="true" EliminaAbilitàPersonaggio="EliminaAbilità" />
			</RadzenColumn>

			<RadzenColumn Size="12" SizeMD="6">
				<SchermataAbilità Titolo="Debolezze" @bind-Abilità="personaggio.Abilità" IsAbilità="false" EliminaAbilitàPersonaggio="EliminaAbilità" />
			</RadzenColumn>
		</RadzenRow>
	</RadzenFieldset>
	<RadzenFab Style="position:fixed;bottom:1rem;right:1rem;" ButtonType="ButtonType.Submit" ButtonStyle="ButtonStyle.Primary" Icon="save" />
</EditForm>

@code {
	[Parameter]
	public Personaggio? personaggio { get; set; } = new Personaggio();
	[Parameter]
	public EventCallback OnSalva { get; set; }

	List<Abilità> AbilitàTotali = new List<Abilità>();
	string titolo = "";

	AbilitàPersonaggio abilitàPersonaggio = new AbilitàPersonaggio();

	protected override async Task OnInitializedAsync()
	{
		titolo = "Nuovo personaggio";
		AbilitàTotali = await abilitàService.GetAbilità();
		if (personaggio.Id != 0)
		{
			titolo = "Modifica Personaggio";
		}
	}

	private void Edita(AbilitàPersonaggio singola)
	{
		singola.Modifica = true; 
	}

	private void EsciDaEdita(AbilitàPersonaggio singola)
	{
		singola.Modifica = false; 
	}

	private async Task Salva()
	{
		await personaggioService.SalvaPersonaggio(personaggio);
		if (OnSalva.HasDelegate)
		{
			await OnSalva.InvokeAsync(); 
		}
	}

	private async Task EliminaAbilità(AbilitàPersonaggio quale)
	{
		bool? result = await dialog.Confirm("Sei sicuro di voler eliminare questa abilità?", "Eliminazione abilità", new ConfirmOptions() { OkButtonText = "Sì", CancelButtonText = "No" });
		if (result.HasValue && result.Value)
		{
			personaggio.Abilità.Remove(quale); 
			notify.Notify(new NotificationMessage() {Severity = NotificationSeverity.Success, Summary ="Abilità eliminata!"}); 
		}
	}

	public void InserisciAbilità()
	{
		if (abilitàPersonaggio.Abilità.Id == 0)
		{
			notify.Notify(new NotificationMessage() { Severity = NotificationSeverity.Warning, Summary = "Non hai ancora inserito un'abilità!" });
			return; 
		}
		abilitàPersonaggio.Personaggio = personaggio; 
		abilitàPersonaggio.PersonaggioId = personaggio.Id; 
		personaggio.Abilità.Add(abilitàPersonaggio);
		abilitàPersonaggio = new AbilitàPersonaggio();
	}
}
