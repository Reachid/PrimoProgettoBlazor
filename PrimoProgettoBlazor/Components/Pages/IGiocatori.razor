@page "/Giocatori"
@inject IGiocatoreService giocatoreService
@inject DialogService dialog
@inject NotificationService notify

@if (inModifica == null)
{
	<RadzenRow>
		@foreach (Giocatore singola in Giocatori)
		{
			<RadzenColumn SizeMD="6" Size="12">
				<RadzenCard>
					<RadzenRow>
						<RadzenColumn Size="12">
							<RadzenText TextAlign="TextAlign.Center" Text="@singola.Nome" />
						</RadzenColumn>
					</RadzenRow>
					<RadzenRow>
						<RadzenColumn Size="6">
							<RadzenButton ButtonStyle="ButtonStyle.Danger" Icon="delete" Click="x => Elimina(singola)" class="w-100" />
						</RadzenColumn>
						<RadzenColumn Size="6">
							<RadzenButton ButtonStyle="ButtonStyle.Warning" Icon="edit" Click="x => Modifica(singola)" class="w-100" />
						</RadzenColumn>
						<RadzenColumn Size="12">
							@{
								string testo = "Non Admin";
								if (singola.IsAdmin)
								{
									testo = "Admin";
								}
								<RadzenButton ButtonStyle="ButtonStyle.Secondary" Text="@testo" Click="x => ImpostaAdmin(singola)" class="w-100" />
							}
						</RadzenColumn>
					</RadzenRow>
				</RadzenCard>
			</RadzenColumn>
		}
	</RadzenRow>
	<RadzenFab Style="position:fixed;bottom:1rem;right:1rem;" ButtonType="ButtonType.Button" ButtonStyle="ButtonStyle.Primary" Icon="add" Click="x => Modifica(new Giocatore())" />
}
else
{
	<EditForm Model="Giocatori" OnSubmit="x => Salva(inModifica)">
		<RadzenRow>
			<RadzenColumn Size="6">
				<RadzenFormField Text="Nome" class="w-100">
					<RadzenTextBox @bind-Value="@inModifica.Nome" class="w-100" />
				</RadzenFormField>
			</RadzenColumn>
		</RadzenRow>
		<RadzenFab Style="position:fixed;bottom:1rem;right:1rem;" ButtonType="ButtonType.Submit" ButtonStyle="ButtonStyle.Primary" Icon="save" />
	</EditForm>
}


@code {
	List<Giocatore> Giocatori = new List<Giocatore>();
	Giocatore? inModifica = null;
	protected override async Task OnInitializedAsync()
	{
		await Carica();
	}

	private async Task Carica()
	{
		Giocatori = await giocatoreService.GetGiocatori();
	}

	private void Modifica(Giocatore quale)
	{
		inModifica = quale;
	}

	private async Task Salva(Giocatore giocatore)
	{
		string errore = await giocatoreService.SalvaGiocatore(giocatore);
		string testo = "Modifica riuscita";
		if (giocatore.Id == 0)
		{
			testo = "Inserimento riuscito";
		}
		MostraErrore(errore, testo);
		inModifica = null;
		await Carica();
	}

	private async Task Elimina(Giocatore quale)
	{
		bool? result = await dialog.Confirm("Sei sicuro di voler eliminare questa sessione?", "Eliminazione sessione", new ConfirmOptions() { OkButtonText = "Sì", CancelButtonText = "No" });
		if (result.HasValue && result.Value)
		{
			string errore = await giocatoreService.EliminaGiocatore(quale);
			MostraErrore(errore, "Elinimazione riuscita!");
			await Carica();
		}
	}

	private async Task ImpostaAdmin(Giocatore giocatore)
	{
		giocatore.IsAdmin = !giocatore.IsAdmin;
		await Salva(giocatore);
	}

	private void MostraErrore(string errore, string messaggioDiRiuscita)
	{
		if (string.IsNullOrEmpty(errore))
		{
			notify.Notify(NotificationSeverity.Success, messaggioDiRiuscita);
		}
		else
		{
			notify.Notify(NotificationSeverity.Error, errore);
		}
	}
}
